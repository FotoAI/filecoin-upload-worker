<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filecoin Upload Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007cba;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #005a87;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .result-details {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .image-preview {
            margin-top: 15px;
            text-align: center;
        }
        .uploaded-image {
            max-width: 100%;
            max-height: 400px;
            border: 2px solid #007cba;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .cdn-links {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9f7ff;
            border-radius: 4px;
        }
        .cdn-link {
            display: block;
            margin: 5px 0;
            padding: 8px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-decoration: none;
            color: #007cba;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        .cdn-link:hover {
            background-color: #f0f8ff;
        }
        .loading-image {
            display: inline-block;
            margin-top: 10px;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Filecoin Upload Test</h1>
        <p>Test the Cloudflare Worker that uploads files to Filecoin using Synapse SDK.</p>
        <div style="background: #e7f3ff; padding: 10px; border-radius: 4px; margin: 15px 0; font-size: 14px;">
            ‚ö° <strong>Ultra-fast responses:</strong> This worker returns results immediately when the Piece CID is available, without waiting for the full upload process to complete.
        </div>

        <form id="uploadForm">
            <div class="form-group">
                <label for="workerUrl">Worker URL:</label>
                <input
                    type="text"
                    id="workerUrl"
                    value="http://localhost:8787"
                    placeholder="https://your-worker.your-subdomain.workers.dev"
                    required
                >
            </div>

            <div class="form-group">
                <label for="userId">User ID:</label>
                <input
                    type="text"
                    id="userId"
                    value="test-user-123"
                    placeholder="Enter user ID"
                    required
                >
            </div>

            <div class="form-group">
                <label for="fileInput">Select File:</label>
                <input type="file" id="fileInput" required>
            </div>

            <div class="form-group">
                <label for="uploadMethod">Upload Method:</label>
                <select id="uploadMethod" onchange="updateMethodInfo()">
                    <option value="multipart">Multipart Form Data (Default)</option>
                    <option value="stream">Direct Stream Upload</option>
                </select>
                <div id="methodInfo" style="font-size: 12px; color: #666; margin-top: 5px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                    <strong>Multipart:</strong> Standard web upload method using FormData. Includes file metadata automatically.
                </div>
            </div>

            <button type="submit" id="uploadBtn">Upload to Filecoin</button>
        </form>

        <div id="status" style="display: none;"></div>
    </div>

    <script>
        const form = document.getElementById('uploadForm');
        const uploadBtn = document.getElementById('uploadBtn');
        const status = document.getElementById('status');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const workerUrl = document.getElementById('workerUrl').value;
            const userId = document.getElementById('userId').value;
            const fileInput = document.getElementById('fileInput');
            const uploadMethod = document.getElementById('uploadMethod').value;

            if (!fileInput.files[0]) {
                showStatus('Please select a file', 'error');
                return;
            }

            const file = fileInput.files[0];
            const methodText = uploadMethod === 'stream' ? 'Stream' : 'Multipart';
            showStatus(`Uploading ${file.name} (${formatFileSize(file.size)}) via ${methodText}...`, 'loading');

            uploadBtn.disabled = true;

            try {
                let requestOptions;

                if (uploadMethod === 'stream') {
                    // Direct stream upload
                    const fileBuffer = await file.arrayBuffer();
                    requestOptions = {
                        method: 'POST',
                        headers: {
                            'user-id': userId,
                            'Content-Type': file.type || 'application/octet-stream',
                            'x-file-name': file.name,
                            'x-file-size': file.size.toString(),
                            'x-upload-method': 'stream'
                        },
                        body: fileBuffer
                    };
                } else {
                    // Multipart form data upload (default)
                    const formData = new FormData();
                    formData.append('file', file);
                    requestOptions = {
                        method: 'POST',
                        headers: {
                            'user-id': userId,
                            'x-upload-method': 'multipart'
                        },
                        body: formData
                    };
                }

                const response = await fetch(workerUrl, requestOptions);
                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus(`‚úÖ Upload successful via ${methodText}!`, 'success', result);
                    displayUploadedContent(result, file);
                } else {
                    showStatus(`‚ùå Upload failed: ${result.message || result.error}`, 'error', result);
                }

            } catch (error) {
                showStatus(`‚ùå Upload failed: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
            }
        });

        function showStatus(message, type, details = null) {
            status.style.display = 'block';
            status.className = type;
            status.innerHTML = message;

            if (details) {
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'result-details';
                detailsDiv.textContent = JSON.stringify(details, null, 2);
                status.appendChild(detailsDiv);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function displayUploadedContent(result, originalFile) {
            // Create CDN links section
            const cdnLinksDiv = document.createElement('div');
            cdnLinksDiv.className = 'cdn-links';
            cdnLinksDiv.innerHTML = `
                <h4>üåê CDN URLs:</h4>
                <p style="font-size: 12px; color: #666; margin: 5px 0;">Files may take 5-10 minutes to be available via CDN</p>
                <a href="${result.cdnUrl}" target="_blank" class="cdn-link">${result.cdnUrl}</a>
            `;

            status.appendChild(cdnLinksDiv);

            // Display image preview if it's an image file
            if (isImageFile(originalFile)) {
                const imagePreviewDiv = document.createElement('div');
                imagePreviewDiv.className = 'image-preview';

                // Show loading state first
                imagePreviewDiv.innerHTML = `
                    <h4>üñºÔ∏è Image Preview:</h4>
                    <div class="loading-image" id="imageLoading">
                        Loading image from CDN... This may take a few minutes.
                    </div>
                `;

                status.appendChild(imagePreviewDiv);

                // Try to load the image from CDN with retry logic
                loadImageWithRetry(result.cdnUrl, imagePreviewDiv);
            }

            // Add copy buttons for easy access
            addCopyButtons(result);
        }

        function isImageFile(file) {
            const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
            return imageTypes.includes(file.type);
        }

        function loadImageWithRetry(imageUrl, containerDiv, retryCount = 0, maxRetries = 10) {
            const img = new Image();

            img.onload = function() {
                containerDiv.innerHTML = `
                    <h4>üñºÔ∏è Image Preview:</h4>
                    <p style="font-size: 12px; color: #28a745; margin: 5px 0;">‚úÖ Image loaded successfully from CDN</p>
                    <img src="${imageUrl}" alt="Uploaded image" class="uploaded-image" />
                `;
            };

            img.onerror = function() {
                if (retryCount < maxRetries) {
                    const waitTime = Math.min(5000 * Math.pow(1.5, retryCount), 30000); // Exponential backoff, max 30s
                    const loadingElement = containerDiv.querySelector('#imageLoading');
                    if (loadingElement) {
                        loadingElement.innerHTML = `
                            Loading image from CDN... Retry ${retryCount + 1}/${maxRetries + 1}
                            (retrying in ${Math.ceil(waitTime/1000)}s)
                        `;
                    }

                    setTimeout(() => {
                        loadImageWithRetry(imageUrl, containerDiv, retryCount + 1, maxRetries);
                    }, waitTime);
                } else {
                    containerDiv.innerHTML = `
                        <h4>üñºÔ∏è Image Preview:</h4>
                        <div class="loading-image" style="color: #dc3545; border-color: #dc3545;">
                            ‚ö†Ô∏è Image not yet available via CDN. Please try the link directly:<br>
                            <a href="${imageUrl}" target="_blank" style="color: #007cba;">Open image in new tab</a>
                        </div>
                    `;
                }
            };

            img.src = imageUrl;
        }

        function addCopyButtons(result) {
            const copyButtonsDiv = document.createElement('div');
            copyButtonsDiv.innerHTML = `
                <div style="margin-top: 15px; text-align: center;">
                    <button type="button" onclick="copyToClipboard('${result.pieceCid}')"
                            style="margin: 5px; padding: 8px 16px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Copy Piece CID
                    </button>
                    <button type="button" onclick="copyToClipboard('${result.cdnUrl}')"
                            style="margin: 5px; padding: 8px 16px; font-size: 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Copy CDN URL
                    </button>
                </div>
            `;
            status.appendChild(copyButtonsDiv);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                // Show temporary success message
                const tempMsg = document.createElement('div');
                tempMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 4px; z-index: 9999;';
                tempMsg.textContent = '‚úÖ Copied to clipboard!';
                document.body.appendChild(tempMsg);
                setTimeout(() => document.body.removeChild(tempMsg), 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
            });
        }

        function updateMethodInfo() {
            const uploadMethod = document.getElementById('uploadMethod').value;
            const methodInfo = document.getElementById('methodInfo');

            if (uploadMethod === 'stream') {
                methodInfo.innerHTML = '<strong>Stream:</strong> Direct file upload as raw bytes. Requires explicit headers (Content-Type, x-file-name, x-file-size).';
            } else {
                methodInfo.innerHTML = '<strong>Multipart:</strong> Standard web upload method using FormData. Includes file metadata automatically.';
            }
        }
    </script>
</body>
</html>